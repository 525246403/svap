{% extends 'video/base.html' %}
{% load static %}
{% block headblock %}

{% endblock %}
<!DOCTYPE html>
<html lang="en">


	<body class="no-skin">
            {% block breadcrub %}
                <li>
                    <a href="javascript:void(0)">目标识别</a>
                </li>
            {% endblock %}
{% block bodyblock %}
        <div class="page-content">
            <div class="col-xs-12">
                <div class="row" style="border: 0.5px #008CD4 solid;height: 62px">
                    <table width="100%" class="CSSearchTbl" cellpadding="0" cellspacing="0">
                    <button class="btn btn-primary pull-left col-sm-12 tbl-search" data-dismiss="modal" style="width: 120px;margin: 10px 30px 10px 30px" onclick="famousjump()" type="button">
                        明星识别
                    </button>
                    <button class="btn btn-primary pull-left col-sm-12 tbl-search" data-dismiss="modal" style="width: 120px;margin: 10px 30px 10px 30px" onclick="politicsjump()" type="button">
                        政治人物识别
                    </button>
                    <button class="btn btn-primary pull-left col-sm-12 tbl-search" data-dismiss="modal"  style="width: 100px;margin: 10px 30px 10px 30px" onclick="deltask()">
                        删除
                    </button>
                    </table>
                </div>
                <div class="row">
                    <table width="100%" class="CSSearchTbl" cellpadding="0" cellspacing="0">
                    筛选/搜索区
                    </table>
                </div>
			</div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="row">
                        <div class="col-xs-12">
                            <table id="sample-table-1" class="table table-striped table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>选择</th>
                                        <th>任务ID</th>
                                        <th>任务视频ID</th>
                                        <th>视频名称</th>
                                        <th>检测目标列表</th>
                                        <th>创建时间</th>
                                        <th>进度</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>

                                <tbody>
                                {% for task in task_list %}
                                    <tr>
                                        <td class="center">
                                            <label class="position-relative">
                                                <input type="checkbox" class="ace" value="{{ task.task_id }}"/>
                                                <span class="lbl"></span>
                                            </label>
                                        </td>
                                        <td class="taskid">{{ task.task_id }}</td>
                                        <td>{{ task.task_media_id }}</td>
                                        <td >{{ task.name }}</td>
                                        <td>{{ task.target_face_name_list }}</td>
                                        <td>{{ task.create_time }}</td>
                                        <td class="progress">{{ task.progress }}</td>
                                        <td class="state">{{ task.state }}</td>
                                        <td><a href="showvideo/?task_id={{ task.task_id }}">{{ task.op }}</a></td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <div id="pagination" style="margin-bottom: 10px;text-align: center">
                            {% if total_page %}
                                <ul id="pagination-flickr">
                                    {% if contacts.has_previous %}
                                    <li class="previous" style="display: inline-block"><a href="?page={{ contacts.previous_page_number }}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}{% if request.GET.month %}&month={{ request.GET.month }}{% endif %}{% if request.GET.cid %}&cid={{ request.GET.cid }}{% endif %}">&laquo;上一页</a></li>
                                    {% else %}
                                    <li class="previous-off" style="display: inline-block">&laquo;上一页</li>
                                    {% endif %}

                                     <li class="active" style="display: inline-block"> {{ contacts.number }}/{{ contacts.paginator.num_pages }}</li>
                                    {% if contacts.has_next %}
                                      <li class="next" style="display: inline-block"><a href="?page={{ contacts.next_page_number }}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}{% if request.GET.month %}&month={{ request.GET.month }}{% endif %}{% if request.GET.cid %}&cid={{ request.GET.cid }}{% endif %}">下一页 &raquo;</a></li>
                                    {% else %}
                                      <li class="next-off" style="display: inline-block">下一页 &raquo;</li>
                                    {% endif %}
                               </ul>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
{% endblock %}
{% block scriptblock %}
<script type="text/javascript">
function famousjump() {
    window.location = "/video/famoustask";
}
function politicsjump() {
    window.location = "/video/politicstask";
}
var task_list = new Array()
function deltask() {
    $(".position-relative :checkbox").each(function(){
            if($(this).prop("checked")){
                var task_id = $(this).val()
                task_list.push(task_id)
            }
        });
    var data = {
        'task_list':JSON.stringify(task_list)
    }
    $.ajax({
            url:'/video/deltask',
                type:'post',
                data:data,
                dataType: 'json',
                success:function (resp){
                if(resp.ret==0){
                    window.location.href="/video/targetrec";
                }else {
                    alert(resp.val)
                }
            }
        })
}

function fresh() {
    $.ajax({
            url:'/video/targetrec',
                type:'post',
                data:"",
                dataType: 'json',
                success:function (resp){
                if(resp.ret==0){
                    var task_id = resp.val.task_id
                    var progress = resp.val.progress
                    $('.taskid').each(function () {
                        if($(this).text()==task_id){
                            var this_ = $(this)
                            console.log(progress)
                            this_.siblings('.progress')[0].innerHTML = progress;
                            this_.siblings('.state')[0].innerHTML = '检测中';
                            if(this_.siblings('.progress').text()=='100.0%'){
                            setTimeout(function(){window.location.reload();},3000);
                            }else {}
                        }
                    })
                }
            }
        })
}

$('.state').each(function () {
    var this_ = $(this)
    if(this_.text()!='完成'){
        setInterval(fresh, 2000);
    }
})
</script>
{% endblock %}

